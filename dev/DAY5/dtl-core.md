---
title: MCPist コア機能定義
aliases:
  - dtl-core
  - core-features
tags:
  - MCPist
  - architecture
  - core
  - DTL
document-type: detail
document-class: DTL
created: 2026-01-14T00:00:00+09:00
updated: 2026-01-14T00:00:00+09:00
---
# MCPist コア機能定義

## ドキュメント管理情報

| 項目 | 値 |
|------|-----|
| Status | `current` |
| Version | v3.2 (DAY5) |
| Note | COR-008(TOON)を強固に格上げ、COR-009(モジュールCLI実装)を追加 |

---

## 概要

本ドキュメントは、MCPistプロジェクトにおける「コア機能」（不変部分）を定義する。

**評価基準:**
- **強固なコア（2つ以上の独立した理由）**: 変更すると複数の設計判断が破綻する
- **暫定的コア（1つの理由のみ）**: その理由が変われば変更可能

**分析対象:**
- ADR-005, ADR-006
- spec-sys.md, spec-dsn.md, spec-inf.md, spec-ops.md
- go-mcp-dev-plan.md, MCPist-Design-Philosophy.md

---

## 除外されたコア候補

### シングルテナント設計（旧COR-001）

**除外理由:**
MCPistの存在意義が進化しているため、コアから除外。

| 変化 | 内容 |
|------|------|
| 当初 | パワーユーザー向け開発ツール（自分のトークンは自分で管理） |
| 現在 | 社内AIインフラのデザインパターン提示 |

**新たな視点:**
- 「他人のトークンを預からない」という信頼境界は
- 「会社が自社社員のトークンを預かる」という、SaaSモデルとは異なる信頼次元の問題
- テナンシーモデルは実装選択であり、コア機能ではない

**ステータス:** 設計選択（コアではない）

---

## 強固なコア（2つ以上の独立した理由）

変更すると複数の独立した設計判断に影響するため、変更しづらい。

### COR-001: メタツール方式（Context Rot対策）

**独立した理由（3つ）:**

| # | 理由 | 根拠 |
|---|------|------|
| 1 | Context Rot防止 | LLMのコンテキストウィンドウ節約（業界課題） |
| 2 | セキュリティ（隠蔽原則） | 権限外ツールは存在すら見せない |
| 3 | MCP仕様の制約回避 | tools/listで全ツール公開する仕様への対策 |

**定義:**
```
初期化時: メタツール3個のみ公開
  - get_module_schema
  - call_module_tool
  - batch

実行時: 権限のあるツール定義のみ返却
```

**導出される設計:**
- get_module_schemaによる遅延読み込み
- Tool Sieveによるフィルタリング
- プロンプトインジェクション対策

**変更の影響:** MCPサーバー設計、モジュール設計、セキュリティ設計

---

### COR-003: 認証をサーバー側に持つ設計

**独立した理由（3つ）:**

| # | 理由 | 根拠 |
|---|------|------|
| 1 | クライアント非依存 | Claude/GPT/ローカルLLM、どれでも同じ認証 |
| 2 | ポータビリティ | ベンダーロックイン回避 |
| 3 | Phase 2 Electron対応 | デスクトップアプリ化時も同じ認証基盤 |

**定義:**
```
従来のMCP:
  User → MCP Host（認証） → MCP Server → 外部API

MCPist:
  User → MCP Host → MCP Server（認証・Token Broker） → 外部API
```

**導出される設計:**
- Token Broker実装
- JWTベース認証
- 管理UIでのトークン登録

**変更の影響:** 全層のアーキテクチャ

---

### COR-004: 決定論的オーケストレーター

**独立した理由（3つ）:**

| # | 理由 | 根拠 |
|---|------|------|
| 1 | 品質管理 | 非決定論的な動作を避け、ツールに徹する |
| 2 | コスト構造 | 内部LLMを持つとAPIコストが発生 |
| 3 | 障害点削減 | 内部LLMの判断ミスはユーザーに見えない |

**定義:**
```
MCPistがやること（決定論的）:
├─ ルーティング
├─ スキーマの動的取得・返却
├─ 認証・認可のプロキシ
├─ エラーハンドリングの統一
└─ 依存解決（DAG）

MCPistがやらないこと（非決定論的）:
├─ データの永続化（ベクトル化、要約）
├─ 判断・選択（ツール選択はLLM側）
├─ コンテキスト生成（RAG不使用）
└─ 非決定論的データ変換
```

**導出される設計:**
- LLM非内蔵
- 中間結果はユーザーLLMのコンテキストを通過

**変更の影響:** 全設計判断の前提

---

### COR-005: RLSに依存しない認可設計

**独立した理由（2つ）:**

| # | 理由 | 根拠 |
|---|------|------|
| 1 | ポータビリティ | SQLiteはRLS非対応（ローカルアプリ化対応） |
| 2 | 多層防御 | RLSは「保険」、主責務はアプリケーション層 |

**定義:**
```
防御層1: MCPサーバー JWT検証 → user_id確定
防御層2: Token Broker user_idフィルタ（主責務）← ここが本体
防御層3: RLS（クラウドのみ） ← 万が一の保険
```

**導出される設計:**
- Edge Function内でuser_idフィルタ
- RLSは補助層として維持

**変更の影響:** Token Broker設計、セキュリティモデル

---

### COR-006: Next.js採用（管理UI）

**独立した理由（3つ）:**

| # | 理由 | 根拠 |
|---|------|------|
| 1 | $0制約 → Vercel Hobby | 無料で静的/SSR両対応のホスティング |
| 2 | SPA設計要件 | モーダル/パネル多用、URL状態管理 |
| 3 | Phase 2 Electron対応 | React/Next.jsベースなら移行容易 |

**注意:** 「$0制約」だけでは暫定的だが、SPA要件とElectron対応という独立した理由が加わり強固になる。

**定義:**
```
$0制約 ──────────────────> Vercel Hobby
                              │
SPA設計要件 ─────────────────┼──> Next.js採用
                              │
Phase 2 Electron対応 ────────┘
```

**導出される設計:**
- App Router使用
- @supabase/ssr連携
- Tailwind CSS

**変更の影響:** 管理UIの実装全体

---

### COR-007: Go採用（MCPサーバー）

**独立した理由（5つ）:**

| # | 理由 | 根拠 |
|---|------|------|
| 1 | $0制約 → Koyeb Free → Docker軽量化 | 軽量バイナリが必要 |
| 2 | SSE直接実装 | 標準ライブラリで外部依存なし |
| 3 | 既存プロジェクト(dwhbi)との差別化 | TypeScriptは既存で使用中 |
| 4 | 非同期・サーバー言語としての適性 | 並行処理、goroutine |
| 5 | サーバー側計算によるコンテキスト節約 | LLMに計算を負担させず、サーバーで処理 |

**定義:**
```
$0制約 → Koyeb Free ─────────────────> Docker軽量化
                                          │
SSE直接実装要件 ─────────────────────────┤
                                          │
既存プロジェクト差別化 ──────────────────┼──> Go採用
                                          │
非同期・サーバー言語適性 ────────────────┤
                                          │
サーバー側計算でコンテキスト節約 ────────┘
```

**変更の影響:** MCPサーバーの実装全体

---

### COR-008: TOON形式（トークン最適化出力）

**独立した理由（2つ）:**

| # | 理由 | 根拠 |
|---|------|------|
| 1 | Context Rot対策 | LLMのコンテキストウィンドウ節約（業界課題） |
| 2 | LLMベンダーの対処動機欠如 | ベンダーはコンテキスト消費でトークン課金するため、自発的な最適化動機がない |

**背景:**
Context RotはLLM業界の構造的問題であり、LLMベンダーには解消する経済的動機がない。
- LLMベンダー: トークン消費 = 収益
- ユーザー: トークン消費 = コスト
- MCPサーバー側でトークン最適化を行う必要がある

参照: [MCPist-vendor-lockin-statement.md](../../docs/20260113014306_MCPist-vendor-lockin-statement.md)

**定義:**
```
TOON（Token-Optimized Output Notation）:
├─ JSONより冗長性を削減
├─ LLMが解釈可能な形式を維持
├─ コンテキストウィンドウの効率的活用
└─ MCPサーバー側で変換

従来:
{"users": [{"name": "Alice", "age": 30}, {"name": "Bob", "age": 25}]}

TOON:
users: Alice(30), Bob(25)
```

**暫定要素:** TOON形式が実際にトークン節約になるかは検証が必要だが、Context Rot対策の必要性は確定しているため、コアとして採用。

**変更の影響:** MCPサーバーのレスポンス形式

---

### COR-009: モジュールのCLI実装

**独立した理由（2つ）:**

| # | 理由 | 根拠 |
|---|------|------|
| 1 | モジュールレジストリ構造の平準化 | 全モジュールが同一インターフェースを持つ |
| 2 | 人間/LLM実行の等価性 | ローカル実行時に人間が直接コマンド実行してもLLMが実行しても結果が変わらない |

**定義:**
```
各モジュールの実装形態:
├─ Go実装のCLIとして独立実装
├─ 外部エンドポイントへ接続
├─ モジュールレジストリからはライブラリとして呼び出し
└─ CLIとして直接実行も可能

呼び出しパターン:
1. LLM経由: MCPサーバー → モジュールレジストリ → モジュール(ライブラリ) → 外部API
2. 人間経由: CLI直接実行 → モジュール(CLI) → 外部API

結果の等価性:
└─ どちらの経路でも同一の結果を返す
```

**導出される設計:**
- 各モジュールはmain.goを持つ
- cobra等のCLIフレームワークを使用
- モジュールレジストリはimportしてライブラリとして呼び出し
- テストはCLI経由でも実行可能

**変更の影響:** モジュール実装アーキテクチャ

---

## 暫定的コア（1つの理由のみ）

理由が1つのため、その理由が変われば変更可能。

### COR-101: $0/月コスト制約

**理由（1つ）:**

| # | 理由 | 根拠 |
|---|------|------|
| 1 | 個人開発ツールに課金したくない | 開発者の意向 |

**注意:** これは「制約」であって「コア機能」ではない。制約が変われば導出される選択も変わる。

**定義:**
```
月額コスト = $0

制約により選択されたサービス:
├─ MCPサーバー: Koyeb Free Tier
├─ Auth/DB: Supabase Free
├─ 管理UI: Vercel Hobby
├─ 監視: Grafana Cloud Free
└─ DNS: Cloudflare Free
```

**もし$10/月まで許容されれば:**
- Koyeb → Fly.io（コールドスタートなし）
- コールドスタート対策（ping.yml）不要

**ステータス:** 暫定的（開発者の意向次第で変更可能）

---

### COR-102: Koyeb選択

**理由（1つ）:**

| # | 理由 | 根拠 |
|---|------|------|
| 1 | $0制約 | 無料枠でDocker対応 |

**もし$0制約がなければ:** Fly.io等に変更可能

**ステータス:** 暫定的（COR-101に依存）

---

### COR-103: Vercel選択

**理由（1つ）:**

| # | 理由 | 根拠 |
|---|------|------|
| 1 | $0制約 | 無料でNext.js最適化 |

**もし$0制約がなければ:** Cloudflare Pages等に変更可能

**注意:** ただしNext.js採用（COR-006）は3つの理由があるため強固。Vercelを変えてもNext.jsは維持される可能性が高い。

**ステータス:** 暫定的（COR-101に依存）

---

### COR-104: コールドスタート対策（ping.yml）

**理由（1つ）:**

| # | 理由 | 根拠 |
|---|------|------|
| 1 | Koyeb Free Tierのスリープ回避 | $0制約からの導出 |

**もしKoyeb以外なら:** 不要になる可能性

**ステータス:** 暫定的（COR-102に依存）

---

## 導出関係（依存ではなく検討順序）

### 強固なコア同士の関係

```
COR-001 (メタツール) ←──> COR-004 (決定論的オーケストレーター)
    相互補強: 両方ともMCPistの責任範囲を明確にする
    - メタツールはContext Rot防止
    - 決定論的はMCPistが「判断」しないことを保証

COR-001 (メタツール) ←──> COR-008 (TOON形式)
    相互補強: 両方ともContext Rot対策
    - メタツールはツール定義の遅延読み込み
    - TOONはレスポンス形式の最適化

COR-003 (サーバー側認証) ←──> COR-005 (RLS非依存)
    相互補強: 認可の責任をアプリケーション層に集約

COR-007 (Go採用) ←──> COR-009 (モジュールCLI実装)
    相互補強: 両方ともGoによる実装を前提
    - MCPサーバーはGoで実装
    - 各モジュールもGo CLIとして実装
```

### 暫定的コアから強固なコアへの影響

```
COR-101 ($0制約) [暫定]
    │
    ├──> COR-102 (Koyeb) [暫定] ──> COR-007 (Go) [強固: 他に4つの理由]
    │
    └──> COR-103 (Vercel) [暫定] ──> COR-006 (Next.js) [強固: 他に2つの理由]
```

**重要:** $0制約が変わっても、Go採用とNext.js採用は他の独立した理由により維持される可能性が高い。

---

## コア機能マトリックス（Tier順）

### Tier 1: 強固（5つの理由）

| ID | コア機能 | 理由数 | 変更影響範囲 |
|----|----------|--------|--------------|
| COR-007 | Go採用 | 5 | MCPサーバー |

### Tier 2: 強固（3つの理由）

| ID | コア機能 | 理由数 | 変更影響範囲 |
|----|----------|--------|--------------|
| COR-001 | メタツール方式 | 3 | MCPサーバー、モジュール |
| COR-003 | サーバー側認証設計 | 3 | 全層 |
| COR-004 | 決定論的オーケストレーター | 3 | 全設計判断 |
| COR-006 | Next.js採用 | 3 | 管理UI |

### Tier 3: 強固（2つの理由）

| ID | コア機能 | 理由数 | 変更影響範囲 |
|----|----------|--------|--------------|
| COR-005 | RLS非依存認可 | 2 | Token Broker |
| COR-008 | TOON形式 | 2 | レスポンス形式 |
| COR-009 | モジュールCLI実装 | 2 | モジュールアーキテクチャ |

### Tier 4: 暫定（1つの理由）

| ID | コア機能 | 理由数 | 変更影響範囲 |
|----|----------|--------|--------------|
| COR-101 | $0/月コスト制約 | 1 | インフラ選定 |
| COR-102 | Koyeb選択 | 1 | MCPサーバーホスティング |
| COR-103 | Vercel選択 | 1 | 管理UIホスティング |
| COR-104 | コールドスタート対策 | 1 | GitHub Actions |

---

## 従来のCOR-003〜016の再分類

| 旧ID | 項目 | 新分類 | 理由 |
|------|------|--------|------|
| COR-003 (認証3層) | → COR-003 (サーバー側認証) + COR-005 (RLS非依存) | 強固 | 複数理由で再構成 |
| COR-004 (モジュール中心) | → COR-002 (メタツール) に統合 | 強固 | メタツールと密接に関連 |
| COR-009〜011 | セキュリティ系 | COR-005に統合 | RLS非依存の一部 |
| COR-012 | コールドスタート | COR-104 | 暫定 | $0制約からの単一導出 |
| COR-013 | 決定論的 | COR-004 | 強固 | 3つの理由 |
| COR-014 | 暗号化 | COR-003に統合 | 強固 | 認証設計の一部 |
| COR-015 | TOON | COR-008 | 強固 | Context Rot対策 + ベンダー動機欠如 |
| COR-016 | 整合性 | 品質要件 | - | コアではなく品質基準 |

---

## 関連ドキュメント

- [spec-sys.md](002-spec-sys/spec-sys.md) - システム仕様書
- [spec-dsn.md](004-spec-dsn/spec-dsn.md) - 設計仕様書
- [spec-inf.md](spec-inf.md) - インフラ仕様書
- [spec-ops.md](spec-ops.md) - 運用仕様書
- [ADR-005](../DAY3/adr/ADR-005-no-rls-dependency.md) - RLSに依存しない認可設計
- [ADR-006](../DAY3/adr/ADR-006-module-centric-primitives.md) - モジュール中心アーキテクチャ
- [go-mcp-dev-plan.md](../DAY1/go-mcp-dev-plan.md) - 実装計画
- [MCPist-Design-Philosophy.md](../DAY2/MCPist-Design-Philosophy.md) - 設計哲学
- [work-log.md](work-log.md) - 作業ログ
