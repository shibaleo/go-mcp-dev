---
title: MCPist システム仕様サブコア定義
aliases:
  - dtl-sys-cor
  - system-sub-core
tags:
  - MCPist
  - architecture
  - sub-core
  - DTL
document-type: detail
document-class: DTL
created: 2026-01-14T00:00:00+09:00
updated: 2026-01-14T00:00:00+09:00
---
# MCPist システム仕様サブコア定義

## ドキュメント管理情報

| 項目 | 値 |
|------|-----|
| Status | `current` |
| Version | v1.0 (DAY5) |
| Note | spec-sys.mdからサブコア要件を抽出 |

---

## 概要

本ドキュメントは、spec-sys.md（システム仕様書）の中で、コア機能（COR-xxx）を前提とした場合に複数の独立した根拠を持つ要件を「サブコア」として定義する。

**評価基準:**
- コア機能を前提とした場合に、2つ以上の独立した根拠を持つ
- そのコア機能が変わらない限り、変更されない

---

## サブコア要件

### SYS-COR-001: 認証3層構造（Layer 1-3）

**前提コア:**
- COR-003 (サーバー側認証設計)
- COR-005 (RLS非依存認可)

**独立した根拠（3つ）:**

| # | 根拠 | 由来コア |
|---|------|----------|
| 1 | サーバー側認証 → 認証ミドルウェアでJWT検証・user_id抽出 | COR-003 |
| 2 | RLS非依存 → Layer 2（Token Broker）が主責務、Layer 3（RLS）は補助 | COR-005 |
| 3 | クライアント非依存 → どのLLMクライアントからでも同一の認証フロー | COR-003 |

**定義:**
```
Layer 1: ユーザー認証（認証ミドルウェア）
  - 「この人は誰か」
  - JWT/Session/API Key検証
  - user_accountID抽出

Layer 2: ツールマスク（Tool Sieve）
  - 「このユーザーは何が使えるか」
  - ロール権限に基づくツールフィルタ
  - 権限外ツールは存在すら見せない

Layer 3: サービス認証（Token Broker）
  - 「各サービスにどう繋ぐか」
  - OAuth 2.0 / API Key管理
  - 完全に隠蔽、LLMは知らない
```

**spec-sys.mdでの位置:** 2.1 MCPサーバー（認証の3層構造）

---

### SYS-COR-002: Tool Sieve（ツールマスク）

**前提コア:**
- COR-001 (メタツール方式)
- COR-003 (サーバー側認証設計)

**独立した根拠（3つ）:**

| # | 根拠 | 由来コア |
|---|------|----------|
| 1 | メタツール方式 → 起動時はメタツールのみ、実行時に権限チェック | COR-001 |
| 2 | サーバー側認証 → user_idに基づくフィルタリングが可能 | COR-003 |
| 3 | Context Rot防止 → 権限外ツールを隠すことでコンテキスト節約 | COR-001 |

**定義:**
```
従来のMCP設計:
起動時 → 全ツール（100個）をLLMコンテキストに読み込み
       → 使わないツールもコンテキストを消費
       → 権限のないツールも見える

MCPist設計（Tool Sieve）:
起動時 → メタツール（3個）のみコンテキストに存在
実行時 → LLMがget_module_schemaを呼ぶ
       → Tool Sieveがロール権限に基づきフィルタリング
       → 権限のあるツールだけ動的に返却

多層防御:
Layer 1: 見せない - 権限のないツールが見えない
Layer 2: 実行させない - 見えないツールを呼び出しても拒否
Layer 3: 検知する - 権限外ツールの呼び出し試行をログ記録
```

**spec-sys.mdでの位置:** 2.1.2 Tool Sieve

---

### SYS-COR-003: Token Broker設計

**前提コア:**
- COR-003 (サーバー側認証設計)
- COR-005 (RLS非依存認可)

**独立した根拠（3つ）:**

| # | 根拠 | 由来コア |
|---|------|----------|
| 1 | サーバー側認証 → MCPサーバーがToken Brokerを呼び出しトークン取得 | COR-003 |
| 2 | RLS非依存 → Edge Function内でuser_idフィルタ（主責務） | COR-005 |
| 3 | ポータビリティ → Phase 2でSQLite版への移行が可能な設計 | COR-005 |

**定義:**
```
Token Broker役割:
├─ トークン仲介: MCPサーバーからの要求に応じて適切なトークンを提供
├─ 認可制御: user_idによるフィルタリングで不正アクセス防止
├─ 暗号化保存: Vaultを使用したトークンの安全な保管
└─ 自動リフレッシュ: OAuth型トークンの期限切れ時に自動更新

解決順序:
1. user_id + role_id + service で個人トークンを検索
2. なければ role_id + service で共有トークンを検索
3. どちらもなければエラー（要連携）
```

**spec-sys.mdでの位置:** 2.3 Token Broker

---

### SYS-COR-004: モジュールレジストリ統合アーキテクチャ

**前提コア:**
- COR-009 (モジュールCLI実装)
- COR-007 (Go採用)
- COR-001 (メタツール方式)

**独立した根拠（3つ）:**

| # | 根拠 | 由来コア |
|---|------|----------|
| 1 | モジュールCLI実装 → 各モジュールは独立したGo CLIとして実装 | COR-009 |
| 2 | Go採用 → 統一的なビルド・テスト・デプロイ | COR-007 |
| 3 | メタツール方式 → モジュールレジストリがメタツール経由でツール提供 | COR-001 |

**定義:**
```
モジュール構造:
modules/
├── notion/
│   ├── client.go      ← Token Broker連携、APIクライアント
│   ├── tools.go       ← Tools実装
│   ├── resources.go   ← Resources実装（Phase 2）
│   └── prompts.go     ← Prompts実装（Phase 2）
├── github/
└── ...

3プリミティブ統合（ADR-006）:
├─ 「リソースプロバイダ」「プロンプトライブラリ」は独立層として実装しない
├─ モジュールレジストリに統合
└─ 各モジュールが3プリミティブ（Tools/Resources/Prompts）を実装
```

**spec-sys.mdでの位置:** 2.1.4 モジュールレジストリ

---

### SYS-COR-005: MCPプロトコルハンドラのステートレス設計

**前提コア:**
- COR-004 (決定論的オーケストレーター)
- COR-007 (Go採用)

**独立した根拠（2つ）:**

| # | 根拠 | 由来コア |
|---|------|----------|
| 1 | 決定論的オーケストレーター → 状態を持たない、判断しない | COR-004 |
| 2 | Go採用 → goroutineによる並行処理、sync.Mapでの軽量状態管理 | COR-007 |

**定義:**
```
MCPサーバー設計原則:
├─ ステートレス設計（状態は何も残らない）
├─ 非決定論的処理は行わない（判断・要約はLLM側の責任）
├─ データ永続化なし（呼び出し結果を保存しない）
└─ Tasks状態管理はインメモリ（sync.Map）+ 必要に応じてDB永続化

MCPistがやること（決定論的）:
├─ ルーティング
├─ スキーマの動的取得・返却
├─ 認証・認可のプロキシ
├─ エラーハンドリングの統一
└─ 依存解決（DAG）

MCPistがやらないこと（非決定論的）:
├─ データの永続化（ベクトル化、要約）
├─ 判断・選択（ツール選択はLLM側）
├─ コンテキスト生成（RAG不使用）
└─ 非決定論的データ変換
```

**spec-sys.mdでの位置:** 2.1 MCPサーバー（設計原則）

---

### SYS-COR-006: 2種類の認証ポイント分離

**前提コア:**
- COR-003 (サーバー側認証設計)
- COR-005 (RLS非依存認可)

**独立した根拠（2つ）:**

| # | 根拠 | 由来コア |
|---|------|----------|
| 1 | サーバー側認証 → MCPサーバー認証とサービス認証を分離 | COR-003 |
| 2 | RLS非依存 → 外部サービス認証はToken Brokerで完結 | COR-005 |

**定義:**
```
認証ポイント1: MCPサーバー認証
  方向: LLMクライアント → MCPサーバー
  プロトコル: JWT / APIトークン
  担当: Authサーバー / 管理UI

認証ポイント2: 外部サービス認証
  方向: MCPサーバー → 外部API
  プロトコル: OAuth 2.0
  担当: Token Broker

分離の意義:
├─ LLMクライアントは外部サービスの認証情報を知らない
├─ 認証情報が自分の管理下にある
└─ ベンダーロックイン回避
```

**spec-sys.mdでの位置:** 4. 2種類の認証

---

## 非サブコア要件（単一根拠）

以下は重要な要件だが、コア機能からの導出が単一であるためサブコアとしない。

| 要件 | 根拠数 | 理由 |
|------|--------|------|
| MCP 2025-11-25対応 | 1 | MCP仕様準拠からの単一導出 |
| Tasks/Elicitation対応 | 1 | MCP仕様準拠からの単一導出 |
| 許可リスト認証 | 1 | シングルユーザー設計からの単一導出 |
| 管理UIのSPA設計 | 1 | COR-006（Next.js）からの単一導出 |
| SSEセッション管理 | 1 | COR-007（Go）からの単一導出 |

---

## サブコアマトリックス

| ID | サブコア要件 | 前提コア | 根拠数 |
|----|--------------|----------|--------|
| SYS-COR-001 | 認証3層構造 | COR-003, COR-005 | 3 |
| SYS-COR-002 | Tool Sieve | COR-001, COR-003 | 3 |
| SYS-COR-003 | Token Broker設計 | COR-003, COR-005 | 3 |
| SYS-COR-004 | モジュールレジストリ統合 | COR-009, COR-007, COR-001 | 3 |
| SYS-COR-005 | ステートレス設計 | COR-004, COR-007 | 2 |
| SYS-COR-006 | 認証ポイント分離 | COR-003, COR-005 | 2 |

---

## 関連ドキュメント

- [dtl-core.md](dtl-core.md) - コア機能定義
- [spec-sys.md](../DAY4/spec-sys.md) - システム仕様書
