---
title: MCPist 運用仕様サブコア定義
aliases:
  - dtl-ops-cor
  - operations-sub-core
tags:
  - MCPist
  - architecture
  - sub-core
  - DTL
document-type: detail
document-class: DTL
created: 2026-01-14T00:00:00+09:00
updated: 2026-01-14T00:00:00+09:00
---
# MCPist 運用仕様サブコア定義

## ドキュメント管理情報

| 項目 | 値 |
|------|-----|
| Status | `current` |
| Version | v1.0 (DAY5) |
| Note | spec-ops.mdからサブコア要件を抽出 |

---

## 概要

本ドキュメントは、spec-ops.md（運用仕様書）の中で、コア機能（COR-xxx）を前提とした場合に複数の独立した根拠を持つ要件を「サブコア」として定義する。

**評価基準:**
- コア機能を前提とした場合に、2つ以上の独立した根拠を持つ
- そのコア機能が変わらない限り、変更されない

---

## サブコア要件

### OPS-COR-001: 放置運用原則

**前提コア:**
- COR-003 (サーバー側認証設計)
- COR-004 (決定論的オーケストレーター)
- COR-101 ($0/月コスト制約)

**独立した根拠（3つ）:**

| # | 根拠 | 由来コア |
|---|------|----------|
| 1 | サーバー側認証 → Token Brokerによる自動トークンリフレッシュ | COR-003 |
| 2 | 決定論的オーケストレーター → 一時的エラーの自動リトライ、判断を要する処理なし | COR-004 |
| 3 | $0制約 → 個人管理前提、運用者=ユーザー=1人、最小コスト | COR-101 |

**定義:**
```
運用原則:
├─ 放置運用: 日常的な手動介入を不要にする
├─ 自動リトライ: 一時的エラー（タイムアウト、レート制限等）は自動リトライ
├─ 最小コスト: 無料枠で運用継続可能
└─ 個人管理: 運用者 = ユーザー = 1人

運用責任:
├─ トークン更新: 自動（都度）
├─ 障害対応: ユーザー（必要時）
├─ セキュリティ更新: ユーザー（月次）
└─ コスト監視: ユーザー（月次）
```

**spec-ops.mdでの位置:** 1. 運用方針

---

### OPS-COR-002: OAuthアプリ登録・トークン管理フロー

**前提コア:**
- COR-003 (サーバー側認証設計)
- COR-005 (RLS非依存認可)

**独立した根拠（2つ）:**

| # | 根拠 | 由来コア |
|---|------|----------|
| 1 | サーバー側認証 → Token BrokerでOAuthトークンを一元管理 | COR-003 |
| 2 | RLS非依存 → タイプA/Bのトークン管理、共有/個人トークンの優先順位解決 | COR-005 |

**定義:**
```
セットアップフロー:
1. リポジトリクローン
2. Supabaseプロジェクト作成（Auth, DB, Edge Functions）
3. 外部サービスOAuthアプリ登録（タイプBのみ）
4. MCPサーバーデプロイ（Koyeb）
5. 管理UIデプロイ（Vercel）
6. allowed_usersにメールアドレス登録
7. 管理UIにログイン → トークン登録
8. MCPクライアント設定

OAuthアプリ登録（プロバイダ別）:
├─ Notion: Internal Integration
├─ GitHub: OAuth App
├─ Jira/Confluence: OAuth 2.0 (3LO)
└─ Google: OAuth 2.0 Client ID
```

**spec-ops.mdでの位置:** 2. 初回セットアップ

---

### OPS-COR-003: 障害検知・アラート設計

**前提コア:**
- COR-003 (サーバー側認証設計)
- COR-101 ($0/月コスト制約)

**独立した根拠（2つ）:**

| # | 根拠 | 由来コア |
|---|------|----------|
| 1 | サーバー側認証 → トークンリフレッシュ失敗の検知が必須 | COR-003 |
| 2 | $0制約 → Grafana Cloud Free枠で監視・アラート | COR-101 |

**定義:**
```
監視項目:
├─ 5xxエラー: 発生時 → Critical
├─ ヘルスチェック失敗: 3回連続 → Critical
├─ トークンリフレッシュ失敗: 発生時 → Critical
├─ レスポンス時間P95 > 5秒: 5分間 → Warning
└─ 4xxエラー率 > 10%: 5分間 → Warning

アラート通知:
├─ Critical: メール（即時対応）
└─ Warning: ログのみ（ダッシュボードで確認）

KPI:
├─ 可用性: 99%（月間7.2時間以内のダウンタイム）
├─ エラー率: < 1%
├─ レスポンス時間P95: < 3秒
└─ レスポンス時間P99: < 5秒
```

**spec-ops.mdでの位置:** 6. 監視・アラート

---

### OPS-COR-004: セキュリティ運用（シークレット管理）

**前提コア:**
- COR-003 (サーバー側認証設計)
- COR-005 (RLS非依存認可)

**独立した根拠（2つ）:**

| # | 根拠 | 由来コア |
|---|------|----------|
| 1 | サーバー側認証 → JWT_SECRET、OAuthトークンのローテーション必須 | COR-003 |
| 2 | RLS非依存 → Vault暗号化トークンの管理、漏洩時の対応手順 | COR-005 |

**定義:**
```
定期タスク:
├─ 依存パッケージ更新: 月次（Dependabotアラート対応）
├─ シークレットローテーション: 年次 or 漏洩時
└─ アクセスログ監査: 月次（不審なアクセス確認）

シークレットローテーション:
├─ JWT_SECRET: 新SECRET生成 → Koyeb環境変数更新 → 再ログイン案内
└─ OAuthトークン: 管理UIでトークン削除 → 再認可

インシデント対応（トークン漏洩時）:
1. 即時: 管理UIで全トークン削除
2. 即時: 外部サービス側でアプリ連携解除
3. 調査: アクセスログで不正利用確認
4. 復旧: Client Secret再生成 → 再認可
```

**spec-ops.mdでの位置:** 5. セキュリティ運用

---

## 非サブコア要件（単一根拠）

以下は重要な要件だが、コア機能からの導出が単一であるためサブコアとしない。

| 要件 | 根拠数 | 理由 |
|------|--------|------|
| コールドスタート対策（ping.yml） | 1 | COR-104（暫定コア）からの単一導出 |
| Supabase日次バックアップ | 1 | Supabase標準機能からの単一導出 |
| ログローテーション | 1 | Grafana Cloud標準からの単一導出 |
| Runbook整備 | 1 | 運用品質からの単一導出 |
| ポストモーテム | 1 | 運用品質からの単一導出 |
| 廃止手順 | 1 | 運用終了要件からの単一導出 |

---

## サブコアマトリックス

| ID | サブコア要件 | 前提コア | 根拠数 |
|----|--------------|----------|--------|
| OPS-COR-001 | 放置運用原則 | COR-003, COR-004, COR-101 | 3 |
| OPS-COR-002 | OAuthアプリ登録・トークン管理 | COR-003, COR-005 | 2 |
| OPS-COR-003 | 障害検知・アラート設計 | COR-003, COR-101 | 2 |
| OPS-COR-004 | セキュリティ運用 | COR-003, COR-005 | 2 |

---

## 関連ドキュメント

- [dtl-core.md](dtl-core.md) - コア機能定義
- [spec-ops.md](../DAY4/spec-ops.md) - 運用仕様書
