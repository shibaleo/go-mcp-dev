# MCPサーバー 機能要件

本ドキュメントは、req-list.mdで「自前実装」「外部規格依存」と分類された要件から、
MCPサーバーに必要な機能を導出する。

---

## 機能カテゴリ一覧

| カテゴリID | カテゴリ名 | 概要 | 機能ID範囲 |
|-----------|-----------|------|-----------|
| FNR-01 | コンテキスト制御 | ペルソナ別ツール制御、情報分離、コンテキスト節約 | FNR-001〜FNR-005 |
| FNR-02 | データアクセス制御 | ローカル完結、外部送信制限 | FNR-006〜FNR-010 |
| FNR-03 | 外部サービス連携 | Notion、Google Calendar、GitHub等 | FNR-011〜FNR-019 |
| FNR-04 | RAG・知識検索 | ユーザー指定範囲での検索 | FNR-020〜FNR-024 |
| FNR-05 | 記録・トレース | タスク・思考の自動記録 | FNR-025〜FNR-029 |
| FNR-06 | ツール設計 | 軽量レスポンス、高速実行 | FNR-030〜FNR-037 |
| FNR-07 | 並列・バックグラウンド実行 | タスク並列実行、バックグラウンド処理 | FNR-038〜FNR-043 |
| FNR-08 | 管理UI | 管理画面、OAuth登録、トークン管理 | FNR-044〜FNR-049 |

---

## FNR-01: コンテキスト制御

### 対応する要件

| REQ-ID | 項目 | 分類 |
|--------|------|------|
| REQ-038 | 個人用情報は仕事用・開発用と混ざらない | 外部規格依存 |
| REQ-039 | 必要最低限の情報だけがコンテキストに含まれる | 外部規格依存 |
| REQ-021 | 個人裁量の範囲で完結する | 自前実装 |

### 必要な機能

| 機能ID | 機能名 | 説明 |
|--------|--------|------|
| FNR-001 | ペルソナ別ツール定義 | ペルソナごとに利用可能なツールを制限 |
| FNR-002 | ツール公開制御 | initialize時に全ツールを見せず、ペルソナに応じて動的に変更 |
| FNR-003 | データソース分離 | ペルソナごとに参照可能なデータソースを制限 |
| FNR-004 | ツール説明最適化 | LLMが適切にツール選択できるよう説明文を明確化 |
| FNR-005 | ユーザー別自動フィルタ | ツール呼び出し時にユーザー別フィルターを自動適用 |

---

## FNR-02: データアクセス制御

### 対応する要件

| REQ-ID | 項目 | 分類 |
|--------|------|------|
| REQ-015 | 業務データは原則ローカルPC内で完結 | 自前実装 |
| REQ-016 | 外部クラウドへの自動送信を行わない | 外部規格依存 |
| REQ-017 | データ保存先・持ち出し範囲を明示的に制御できる | 自前実装 |
| REQ-018 | ログ・中間生成物もローカル管理される | 自前実装 |
| REQ-023 | 他人のデータ侵害につながる設計は避けられていること | 自前実装 |
| REQ-024 | 権限・データ境界が明確に分離されていること | 自前実装 |

### 必要な機能

| 機能ID | 機能名 | 説明 |
|--------|--------|------|
| FNR-006 | ローカルファイル操作 | ローカルファイルの読み書き・検索 |
| FNR-007 | データ送信先制御 | 外部送信可否をツール・ペルソナ単位で設定 |
| FNR-008 | 保存先パラメータ | ツール実行時に保存先を明示的に指定可能 |
| FNR-009 | ローカルログ保存 | MCPサーバーのログをローカルに保存 |
| FNR-010 | 一時ファイル管理 | 中間生成物の自動クリーンアップ |

---

## FNR-03: 外部サービス連携

### 対応する要件

| REQ-ID | 項目 | 分類 |
|--------|------|------|
| REQ-006 | タスク・アイデア・思考が自動で記録される | 外部規格依存 |
| REQ-008 | データを自動取得・整理 | 外部規格依存 |

### 必要な機能

| 機能ID | 機能名 | 説明 |
|--------|--------|------|
| FNR-011 | Notion連携 | ページ・データベース操作 |
| FNR-012 | Google Calendar連携 | 予定の取得・作成 |
| FNR-013 | Microsoft Todo連携 | タスクの取得・作成・更新 |
| FNR-014 | GitHub連携 | リポジトリ・Issue・PR操作 |
| FNR-015 | Supabase連携 | DB操作・ストレージ・ログ |
| FNR-016 | Jira連携 | Issue・Project操作 |
| FNR-017 | Confluence連携 | Wiki操作 |
| FNR-018 | 健康データ連携 | Fitbit等からのデータ取得（将来） |
| FNR-019 | 財務データ連携 | 銀行API等からのデータ取得（将来） |

---

## FNR-04: RAG・知識検索

### 対応する要件

| REQ-ID | 項目 | 分類 |
|--------|------|------|
| REQ-004 | 参照データはユーザー指定の範囲に限定 | 外部規格依存 |
| REQ-005 | 信頼性の低いWeb情報は混入しない | 自前実装 |
| REQ-044 | コンテキスト生成は過去の自分の知識＋少し背伸びした知識のみ | 外部規格依存 |
| REQ-045 | 俯瞰的レポート・分析が生成可能 | 外部規格依存 |

### 必要な機能

| 機能ID | 機能名 | 説明 |
|--------|--------|------|
| FNR-020 | セマンティック検索 | ベクトル検索による類似文書取得 |
| FNR-021 | キーワード検索 | 全文検索による文書取得 |
| FNR-022 | 検索範囲制限 | ユーザー指定のソース・コレクションに限定 |
| FNR-023 | ドキュメントインデックス | ローカル文書のベクトル化・インデックス作成 |
| FNR-024 | 信頼ソースフィルタ | Web検索を無効化、または信頼ソースに限定 |

---

## FNR-05: 記録・トレース

### 対応する要件

| REQ-ID | 項目 | 分類 |
|--------|------|------|
| REQ-006 | タスク・アイデア・思考が自動で記録される | 外部規格依存 |
| REQ-007 | 手作業での記録不要 | 外部規格依存 |
| REQ-046 | 創作タスクや日常活動への影響を考慮した助言が可能 | 外部規格依存 |
| REQ-047 | アイデアを入力すると即座にタスク化・実行可能 | 外部規格依存 |

### 必要な機能

| 機能ID | 機能名 | 説明 |
|--------|--------|------|
| FNR-025 | タスク自動記録 | ツール実行結果の自動記録 |
| FNR-026 | 思考ログ記録 | ユーザー入力・LLM出力の記録 |
| FNR-027 | タスク作成API | アイデアからタスクを作成 |
| FNR-028 | 履歴検索 | 過去のタスク・思考ログの検索 |
| FNR-029 | 分析データ提供 | 集計・傾向データの取得 |

---

## FNR-06: ツール設計

### 対応する要件

| REQ-ID | 項目 | 分類 |
|--------|------|------|
| REQ-003 | タスク完了結果だけを返す（軽量タスク） | 自前実装 |
| REQ-009 | 成果物が利用可能状態で返却 | 自前実装 |
| REQ-048 | 実行速度は体感的にストレスがない | 自前実装 |
| REQ-050 | タスク構造をDAG等で可視化できる | 外部規格依存 |
| REQ-051 | 計画と実行が分離されている | 外部規格依存 |
| REQ-057 | 待ち時間が思考を中断しないこと | 自前実装 |
| REQ-058 | 「待たされている感覚」が最小限であること | 自前実装 |

### 必要な機能

| 機能ID | 機能名 | 説明 |
|--------|--------|------|
| FNR-030 | 軽量レスポンス設計 | 必要最小限の情報のみを返却 |
| FNR-031 | 成果物直接返却 | 生成物をすぐ利用可能な形式で返却 |
| FNR-032 | 高速実行最適化 | ツール実行の高速化 |
| FNR-033 | タイムアウト設定 | 長時間実行の自動中断 |
| FNR-034 | 進捗報告 | 長時間タスクの進捗情報提供 |
| FNR-035 | バッチ処理対応 | 複数アイテムの一括処理 |
| FNR-036 | 計画・実行分離 | 計画用ツールと実行用ツールを分離 |
| FNR-037 | タスク構造出力 | DAG形式でのタスク依存関係出力 |

---

## FNR-07: 並列・バックグラウンド実行

### 対応する要件

| REQ-ID | 項目 | 分類 |
|--------|------|------|
| REQ-002 | 依存関係のないタスクは並列実行される | 自前実装 |
| REQ-010 | 軽量タスクは並列処理され待ち時間を最小化 | 自前実装 |
| REQ-011 | 大量の単純・軽量タスクを並列で処理できる | 自前実装 |
| REQ-012 | 処理はバックグラウンド実行が可能 | 自前実装 |
| REQ-014 | チャットUIや他作業をブロックしない | 自前実装 |
| REQ-022 | 調査・生成・準備タスクは可能な限り並列実行されること | 自前実装 |

### 設計方針

- LLMはタスクの指定とスケジューリングのみ担当
- MCPサーバーがタスクを受け取り実行
- 並列実行・バックグラウンド処理はMCPサーバー側で制御

### 必要な機能

| 機能ID | 機能名 | 説明 |
|--------|--------|------|
| FNR-038 | タスクキュー | タスクをキューに登録し順次実行 |
| FNR-039 | 並列実行制御 | 依存関係のないタスクを並列実行 |
| FNR-040 | バックグラウンド実行 | 非同期でタスクを実行しUIをブロックしない |
| FNR-041 | タスク状態管理 | タスクの状態（待機/実行中/完了/失敗）を管理 |
| FNR-042 | 結果取得API | バックグラウンドタスクの結果を取得 |
| FNR-043 | タスク依存関係解決 | 依存関係を解析し実行順序を決定 |

---

## FNR-08: 管理UI

### 対応する要件

| REQ-ID | 項目 | 分類 |
|--------|------|------|
| REQ-093 | 初回セットアップ | 自前実装 |
| REQ-094 | 一元的管理UIの提供 | 自前実装 |
| REQ-096 | MCPサーバーの単一エンドポイント提供 | 自前実装 |

### 必要な機能

| 機能ID | 機能名 | 説明 |
|--------|--------|------|
| FNR-044 | 管理UI提供 | 管理画面のWebアプリケーション提供 |
| FNR-045 | OAuthクライアント登録 | 外部サービスのClient ID/Secret登録フォーム |
| FNR-046 | 認可フロー実行 | redirect → 同意 → callback の一連の処理 |
| FNR-047 | トークン状態確認 | 各外部サービスのトークン状態表示（有効/期限切れ/未登録） |
| FNR-048 | トークン削除・再認可 | 登録済みトークンの削除と再認可フロー |
| FNR-049 | ユーザープロフィール編集 | ツール公開設定の編集UI |

---

## 優先度

### P0: 必須（コア機能）

| 機能ID | 機能名 |
|--------|--------|
| FNR-001 | ペルソナ別ツール定義 |
| FNR-006 | ローカルファイル操作 |
| FNR-011 | Notion連携 |
| FNR-012 | Google Calendar連携 |
| FNR-014 | GitHub連携 |
| FNR-015 | Supabase連携 |
| FNR-030 | 軽量レスポンス設計 |

### P1: 重要（UX向上）

| 機能ID | 機能名 |
|--------|--------|
| FNR-002 | ツール公開制御 |
| FNR-005 | ユーザー別自動フィルタ |
| FNR-007 | データ送信先制御 |
| FNR-020 | セマンティック検索 |
| FNR-021 | キーワード検索 |
| FNR-025 | タスク自動記録 |
| FNR-031 | 成果物直接返却 |
| FNR-038 | タスクキュー |
| FNR-040 | バックグラウンド実行 |

### P2: 推奨（完成度向上）

| 機能ID | 機能名 |
|--------|--------|
| FNR-003 | データソース分離 |
| FNR-009 | ローカルログ保存 |
| FNR-013 | Microsoft Todo連携 |
| FNR-016 | Jira連携 |
| FNR-017 | Confluence連携 |
| FNR-022 | 検索範囲制限 |
| FNR-026 | 思考ログ記録 |
| FNR-032 | 高速実行最適化 |
| FNR-039 | 並列実行制御 |
| FNR-041 | タスク状態管理 |
| FNR-042 | 結果取得API |

### P3: 将来（拡張機能）

| 機能ID | 機能名 |
|--------|--------|
| FNR-018 | 健康データ連携 |
| FNR-019 | 財務データ連携 |
| FNR-023 | ドキュメントインデックス |
| FNR-029 | 分析データ提供 |
| FNR-036 | 計画・実行分離 |
| FNR-037 | タスク構造出力 |
| FNR-043 | タスク依存関係解決 |

---

## 関連ドキュメント

- [非機能要件](req-nfr.md)
- [スコープ外機能](req-ofs.md)
- [要件一覧](req-list.md)
- [ペルソナサマリー](user-analysis-summary.md)
