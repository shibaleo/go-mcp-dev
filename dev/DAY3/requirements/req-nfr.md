# MCPサーバー 非機能要件

本ドキュメントは、MCPサーバーの非機能要件を定義する。
MCPサーバーの利用準備、可観測性、安全性に関する要件を含む。

---

## 非機能要件カテゴリ一覧

| カテゴリID | カテゴリ名 | 概要 | 機能ID範囲 |
|-----------|-----------|------|-----------|
| NFR-01 | アカウント・認証管理 | マルチアカウント分離、認証情報管理（利用準備） | NFR-001〜NFR-006 |
| NFR-02 | ログ・可観測性 | 構造化ログ、監視ダッシュボード | NFR-007〜NFR-014 |
| NFR-03 | 安全設計 | 確認ステップ、権限分離、セキュリティ | NFR-015〜NFR-022 |
| NFR-04 | パフォーマンス | レスポンス速度、並列実行 | NFR-023〜NFR-026 |
| NFR-05 | 運用性 | コスト、障害対応、保守性 | NFR-027〜NFR-030 |
| NFR-06 | 拡張性・保守性 | モジュール設計、テスト容易性、コンテキスト最適化 | NFR-031〜NFR-036 |
| NFR-07 | 管理UI認証 | 管理画面認証、セッション管理 | NFR-035〜NFR-037 |

---

## 役割の定義

| 役割 | 関心事 | 主な活動 |
|------|--------|----------|
| **ユーザー** | LLMとの会話体験 | タスク依頼、結果確認 |
| **運用者** | サーバーの維持・管理 | トークン管理、障害対応、コスト管理 |
| **開発者** | コードの変更・拡張 | モジュール追加、バグ修正、テスト |

---

## NFR-01: アカウント・認証管理

MCPサーバーを利用可能にするための準備として必要な要件。

### 対応する要件

| REQ-ID | 項目 | 分類 |
|--------|------|------|
| REQ-001 | 個人用アカウントは他アカウントと物理的・論理的に分離 | 外部規格依存 |
| REQ-041 | アカウント切り替え操作は最小限 | LLMベンダ依存 |
| REQ-013 | ユーザー操作なしで継続実行できる | 外部規格依存 |

### 必要な機能

| 機能ID | 機能名 | 説明 | 対象役割 |
|--------|--------|------|----------|
| NFR-001 | マルチアカウント管理 | 複数アカウント（個人用、仕事用、開発用）の認証情報を分離管理 | 運用者 |
| NFR-002 | アカウント別認証ストア | アカウントごとに認証トークンを保存・取得 | 運用者 |
| NFR-003 | 自動認証リフレッシュ | トークン期限切れ時の自動更新 | 運用者 |
| NFR-004 | アカウント切り替えAPI | ペルソナ切り替え時のアカウント自動選択 | ユーザー |
| NFR-005 | トークン暗号化 | AES-256-GCMでリフレッシュトークン保存 | 運用者 |
| NFR-006 | 通信暗号化 | 全接続でTLS 1.3 | 運用者 |

---

## NFR-02: ログ・可観測性

ログ監視用ダッシュボード等で確認するための要件。

### 対応する要件

| REQ-ID | 項目 | 分類 |
|--------|------|------|
| REQ-026 | 基本的に放置運用が可能であること | 自前実装 |
| REQ-027 | 障害対応が頻発しないこと | 自前実装 |
| REQ-028 | 長期間触らなくても再開可能であること | 自前実装 |
| REQ-029 | 状態把握に必要な情報がログから得られること | 自前実装 |
| REQ-030 | ログが構造化されて保存されること | 自前実装 |
| REQ-031 | 後から検索・分析できること | 自前実装 |
| REQ-032 | ログが過剰でノイズだらけにならないこと | 自前実装 |
| REQ-033 | ログ取得が動作や集中を妨げないこと | 自前実装 |
| REQ-020 | 必要なときだけ詳細を確認できる | 自前実装 |
| REQ-052 | 失敗時は必ず明確に通知される | 自前実装 |

### 必要な機能

| 機能ID | 機能名 | 説明 | 対象役割 |
|--------|--------|------|----------|
| NFR-007 | 構造化ログ出力 | JSON形式での構造化ログ | 運用者・開発者 |
| NFR-008 | ログレベル制御 | DEBUG/INFO/WARN/ERROR レベル設定 | 運用者・開発者 |
| NFR-009 | 非同期ログ書き込み | パフォーマンス影響を最小化 | 開発者 |
| NFR-010 | ログ検索API | 期間・レベル・キーワードでの検索 | 運用者 |
| NFR-011 | ログローテーション | 古いログの自動削除・アーカイブ | 運用者 |
| NFR-012 | エラーレスポンス設計 | 失敗時に明確なエラー情報を返却 | ユーザー |
| NFR-013 | ヘルスチェック | サーバー状態の確認API | 運用者 |
| NFR-014 | ログ収集連携 | Grafana Cloud Loki等でログ確認可能 | 運用者 |

---

## NFR-03: 安全設計

MCPサーバー利用の安全性に関する要件。

### 対応する要件

| REQ-ID | 項目 | 分類 |
|--------|------|------|
| REQ-019 | 対外コミュニケーションは自動実行しない | 自前実装 |
| REQ-049 | 重要な判断ポイントは人間確認が前提 | LLMベンダ依存 |
| REQ-053 | 判断権は常にユーザーに残る | LLMベンダ依存 |
| REQ-025 | デフォルトが安全側の実装であること | 自前実装 |
| REQ-060 | データ消失リスクは極力回避されること | 自前実装 |
| REQ-061 | 他人に被害が出る可能性のある失敗は回避されること | 自前実装 |
| REQ-062 | 危険な操作は事前確認が入ること | LLMベンダ依存 |
| REQ-059 | 致命的なセキュリティリスクは必ず明示されること | 自前実装 |

### 必要な機能

| 機能ID | 機能名 | 説明 | 対象役割 |
|--------|--------|------|----------|
| NFR-015 | 危険操作フラグ | 破壊的操作にフラグを付与 | ユーザー |
| NFR-016 | 確認ステップ挿入 | 危険操作実行前に確認を要求 | ユーザー |
| NFR-017 | 読み取り専用モード | 書き込み操作を無効化するモード | 運用者 |
| NFR-018 | ドライランモード | 実行せずに結果をシミュレーション | ユーザー |
| NFR-019 | 外部送信禁止設定 | メール送信等のツールを無効化 | 運用者 |
| NFR-020 | バックアップ作成 | 破壊的操作前の自動バックアップ | 運用者 |
| NFR-021 | リスク情報付与 | ツールレスポンスにリスク情報を含める | ユーザー |
| NFR-022 | リトライ機構 | Token Exchanger接続はリトライ付き | 運用者 |

---

## NFR-04: パフォーマンス

ユーザー体験に関わるパフォーマンス要件。

### 対応する要件

| REQ-ID | 項目 | 分類 |
|--------|------|------|
| REQ-048 | 実行速度は体感的にストレスがない | 自前実装 |
| REQ-057 | 待ち時間が思考を中断しないこと | 自前実装 |
| REQ-058 | 「待たされている感覚」が最小限であること | 自前実装 |

### 必要な機能

| 機能ID | 機能名 | 説明 | 対象役割 |
|--------|--------|------|----------|
| NFR-023 | 高速レスポンス | タスク処理が高速であること | ユーザー |
| NFR-024 | 途中経過通知 | 長時間タスクは進捗を表示 | ユーザー |
| NFR-025 | コールドスタート対策 | 定期ヘルスチェックでスリープ回避 | 運用者 |
| NFR-026 | タイムアウト設定 | 長時間実行の自動中断 | 運用者 |

---

## NFR-05: 運用性

サーバーの維持・管理に関する要件。

### 必要な機能

| 機能ID | 機能名 | 説明 | 対象役割 |
|--------|--------|------|----------|
| NFR-027 | 無料枠運用 | 無料枠で運用可能（$0/月） | 運用者 |
| NFR-028 | 放置運用 | 基本的に放置運用が可能 | 運用者 |
| NFR-029 | 障害復旧 | 障害からの復旧が容易 | 運用者 |
| NFR-030 | 長期再開 | 長期間触らなくても再開可能 | 運用者 |

---

## NFR-06: 拡張性・保守性

開発者向けの設計要件およびLLMコンテキスト最適化要件。

### 対応する要件

| REQ-ID | 項目 | 分類 |
|--------|------|------|
| REQ-039 | 必要最低限の情報だけがコンテキストに含まれる | 外部規格依存 |
| REQ-040 | タスク実行時に不要な情報参照が発生しない | LLMベンダ依存 |

### 必要な機能

| 機能ID | 機能名 | 説明 | 対象役割 |
|--------|--------|------|----------|
| NFR-031 | ステートレス設計 | サーバーは状態を持たない | 開発者 |
| NFR-032 | モジュール拡張性 | モジュールの追加・変更が容易 | 開発者 |
| NFR-033 | テスト容易性 | 各モジュールが独立してテスト可能 | 開発者 |
| NFR-034 | デバッグログ | デバッグ可能なログ出力 | 開発者 |
| NFR-035 | Context Rot防止 | LLMコンテキストに不要なツールスキーマが含まれないこと | ユーザー・開発者 |
| NFR-036 | 選択的スキーマ取得 | 必要なモジュールのスキーマのみを取得できること | ユーザー・開発者 |

---

## NFR-07: 管理UI認証

### 対応する要件

| REQ-ID | 項目 | 分類 |
|--------|------|------|
| REQ-095 | 管理画面のログイン機能 | 自前実装 |

### 必要な機能

| 機能ID | 機能名 | 説明 | 対象役割 |
|--------|--------|------|----------|
| NFR-037 | 管理画面認証 | 管理UIへのログイン認証（Authサーバー経由） | 運用者 |
| NFR-038 | セッション管理 | ログインセッションの有効期限管理 | 運用者 |
| NFR-039 | 認証失敗時ロックアウト | 連続失敗時の一時的アクセス制限 | 運用者 |

---

## 設計原則（非機能要件ではない）

以下は非機能要件ではなく**設計原則**:

- 決定論的処理に徹する
- バックエンドLLMを持たない
- データ永続化しない（ベクトル化しない）
- シングルテナント・シングルユーザー・マルチアカウント

---

## 優先度

### P0: 必須

| 機能ID | 機能名 |
|--------|--------|
| NFR-001 | マルチアカウント管理 |
| NFR-002 | アカウント別認証ストア |
| NFR-007 | 構造化ログ出力 |
| NFR-012 | エラーレスポンス設計 |
| NFR-015 | 危険操作フラグ |
| NFR-035 | Context Rot防止 |
| NFR-036 | 選択的スキーマ取得 |

### P1: 重要

| 機能ID | 機能名 |
|--------|--------|
| NFR-003 | 自動認証リフレッシュ |
| NFR-005 | トークン暗号化 |
| NFR-008 | ログレベル制御 |
| NFR-013 | ヘルスチェック |
| NFR-016 | 確認ステップ挿入 |
| NFR-023 | 高速レスポンス |

### P2: 推奨

| 機能ID | 機能名 |
|--------|--------|
| NFR-004 | アカウント切り替えAPI |
| NFR-010 | ログ検索API |
| NFR-014 | ログ収集連携 |
| NFR-020 | バックアップ作成 |
| NFR-024 | 途中経過通知 |

### P3: 将来

| 機能ID | 機能名 |
|--------|--------|
| NFR-018 | ドライランモード |
| NFR-025 | コールドスタート対策 |

---

## 関連ドキュメント

- [機能要件](req-fnr.md)
- [スコープ外機能](req-ofs.md)
- [要件一覧](req-list.md)
- [ペルソナサマリー](user-analysis-summary.md)
